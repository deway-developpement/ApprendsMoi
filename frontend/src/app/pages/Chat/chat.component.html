<div class="chat-container">
  <!-- Header -->
  <div class="chat-header">
    <div class="header-left">
      <h1>ðŸ’¬ Messages</h1>
      <div 
        class="connection-status"
        [class.connected]="isSignalRConnected"
        [class.disconnected]="!isSignalRConnected"
        [title]="isSignalRConnected ? 'ConnectÃ© au chat en temps rÃ©el' : 'DÃ©connectÃ© du chat en temps rÃ©el'">
        <span class="status-dot"></span>
        <span class="status-text">{{ isSignalRConnected ? 'En ligne' : 'Hors ligne' }}</span>
      </div>
    </div>
    <button 
      *ngIf="currentUser?.profileType === ProfileType.Parent" 
      (click)="openCreateChatModal()"
      type="button"
      class="btn-primary">
      + DÃ©marrer une nouvelle discussion
    </button>
    <button 
      *ngIf="currentUser?.profileType === ProfileType.Student" 
      (click)="openCreateChatModal()"
      type="button"
      class="btn-primary">
      + Envoyer un message au professeur
    </button>
    <button 
      *ngIf="currentUser?.profileType === ProfileType.Teacher" 
      (click)="openCreateChatModal()"
      type="button"
      class="btn-primary">
      + Contacter un parent
    </button>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="alert alert-error">
    {{ error }}
    <button (click)="error = ''" class="close">Ã—</button>
  </div>

  <div class="chat-layout">
    <!-- Chat List -->
    <div class="chat-list">
      <div class="chat-list-header">
        <h2>Chats</h2>
        <span class="badge">{{ chats.length }}</span>
      </div>
      
      <div *ngIf="chats.length === 0" class="empty-state">
        <p>Aucune discussion pour le moment</p>
        <small *ngIf="currentUser?.profileType === ProfileType.Parent">
          DÃ©marrez une conversation avec un professeur en cliquant sur le bouton ci-dessus
        </small>
      </div>

      <div 
        *ngFor="let chat of chats" 
        (click)="selectChat(chat)"
        [class.active]="selectedChat?.chatId === chat.chatId"
        class="chat-item">
        <div class="chat-item-avatar">
          {{ chat.participantName.charAt(0).toUpperCase() }}
        </div>
        <div class="chat-item-content">
          <div class="chat-item-name">{{ chat.participantName }}</div>
          <div class="chat-item-preview">
            {{ chat.lastMessage || 'Aucun message pour le moment' }}
          </div>
        </div>
        <span class="unread-badge" *ngIf="chat.unreadCount > 0">{{ chat.unreadCount }}</span>
      </div>
    </div>

    <!-- Chat Detail -->
    <div class="chat-detail">
      <div *ngIf="!selectedChat" class="empty-state">
        <p>ðŸ“­ SÃ©lectionnez une discussion pour commencer Ã  Ã©changer</p>
      </div>

      <div *ngIf="selectedChat" class="chat-window">
        <!-- Chat Header -->
        <div class="chat-window-header">
          <div>
            <h3>{{ selectedChat.participantName }}</h3>
            <small>{{ selectedChat.chatType === ChatType.ParentChat ? 'Discussion parent' : 'Discussion Ã©lÃ¨ve' }}</small>
            <small *ngIf="selectedChat.isReadOnly" class="read-only-badge">ðŸ“– Lecture seule</small>
          </div>
          <button 
            (click)="archiveChat()" 
            [disabled]="selectedChat.isReadOnly"
            class="btn-icon" 
            title="Archiver la discussion">ðŸ“¦
          </button>
        </div>

        <!-- Messages -->
        <div class="messages-container">
          <div 
            *ngFor="let message of selectedChat.messages" 
            [class.own-message]="message.senderId === currentUser?.id"
            class="message">
            <div class="message-header">
              <strong>{{ message.senderName }}</strong>
              <small>{{ message.createdAt | date:'short' }}</small>
            </div>
            <div class="message-content">{{ message.content }}</div>
            <div *ngIf="message.attachments.length > 0" class="message-attachments">
              <a 
                *ngFor="let attachment of message.attachments"
                [href]="attachment.fileUrl"
                target="_blank"
                class="attachment-link">
                ðŸ“Ž {{ attachment.fileName }}
              </a>
            </div>
          </div>
          <div *ngIf="typingUsers.size > 0" class="typing-indicator">
            <span>{{ Array.from(typingUsers).join(', ') }} est en train d'Ã©crire...</span>
          </div>
        </div>

        <!-- Message Input -->
        <div class="message-input-area">
          <div *ngIf="selectedChat.isReadOnly" class="read-only-notice">
            ðŸ“– Vous avez accÃ¨s en lecture seule Ã  cette discussion
          </div>
          <div class="input-row">
            <textarea 
              [(ngModel)]="messageContent"
              (keyup.enter)="sendMessage()"
              (keyup)="onMessageInput()"
              [disabled]="selectedChat.isReadOnly"
              placeholder="Ecrivez un message... (Entre pour envoyer)"
              rows="3">
            </textarea>
            <button 
              (click)="sendMessage()"
              [disabled]="!messageContent.trim() || loading || selectedChat.isReadOnly"
              class="btn-primary">
              {{ loading ? 'Envoi...' : 'Envoyer' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Chat Modal -->
  <div *ngIf="showCreateChatModal" class="modal-overlay" (click)="closeCreateModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          <span *ngIf="currentUser?.profileType === ProfileType.Parent">DÃ©marrer une nouvelle discussion</span>
          <span *ngIf="currentUser?.profileType === ProfileType.Student">Envoyer un message au professeur</span>
          <span *ngIf="currentUser?.profileType === ProfileType.Teacher">Contacter un parent</span>
        </h2>
        <button (click)="closeCreateModal()" class="close">Ã—</button>
      </div>
      <div class="modal-body">
        <label>Trouver un professeur</label>
        <input 
          [(ngModel)]="teacherSearchTerm"
          (input)="applyTeacherFilter()"
          type="text"
          placeholder="Rechercher par nom, email ou ville"
          class="form-input">
        <div class="teacher-list">
          <div *ngIf="loadingTeachers" class="teacher-list-empty">Chargement des professeurs...</div>
          <div *ngIf="!loadingTeachers && filteredTeachers.length === 0" class="teacher-list-empty">
            Aucun professeur trouvÃ©.
          </div>
          <button
            type="button"
            *ngFor="let teacher of filteredTeachers"
            class="teacher-item"
            [class.selected]="teacher.id === newChatTeacherId"
            (click)="selectTeacher(teacher)">
            <div class="teacher-name">{{ teacher.firstName }} {{ teacher.lastName }}</div>
            <div class="teacher-meta">
              <span>{{ teacher.email || 'Aucun email' }}</span>
              <span *ngIf="teacher.city">â€¢ {{ teacher.city }}</span>
            </div>
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button (click)="closeCreateModal()" class="btn-secondary">Annuler</button>
        <button 
          (click)="createNewChat()"
          [disabled]="!newChatTeacherId.trim() || loading"
          class="btn-primary">
          {{ loading ? 'CrÃ©ation...' : 'DÃ©marrer la discussion' }}
        </button>
      </div>
    </div>
  </div>
</div>

