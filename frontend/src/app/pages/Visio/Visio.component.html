<app-header theme="light"></app-header>

<section class="visio-hero">
  <div class="visio-hero__content">
    <p class="visio-hero__eyebrow">ApprendsMoi · Visio</p>
    <h1 class="visio-hero__title">Salle de visio & chat</h1>
    <br />
  </div>
</section>

<main class="visio-layout">
  <section class="visio-card visio-card--meeting">
    <header class="visio-card__header">
      <div class="visio-card__title-group">
        <h2 class="visio-card__title">Classe en direct</h2>
        <span class="visio-badge">En direct</span>
      </div>
      <div class="visio-card__actions">
        <app-button variant="primary" (click)="leaveVisio()">Quitter la visio</app-button>
      </div>
    </header>

    <div class="zoom-container" #zoomContainer>
      <div *ngIf="isLoadingMeeting" class="zoom-status">Chargement de la réunion...</div>
      <div *ngIf="!sdkReady && !isInitializingSdk && !isLoadingMeeting && !sdkError" class="zoom-placeholder">
        <p>Initialisation de la visioconference...</p>
      </div>
      <div *ngIf="isInitializingSdk" class="zoom-status">Chargement de la réunion...</div>
      <div *ngIf="sdkError" class="zoom-error">
        <p>{{ sdkError }}</p>
        <button (click)="loadMeetingAndInit()" class="retry-button">Réessayer</button>
      </div>  
    </div>
  </section>

  <aside class="visio-card visio-card--chat">
    <header class="visio-card__header">
      <div class="visio-card__title-group">
        <h2 class="visio-card__title">Chat de classe</h2>
        <span class="chat-tiger-pill">Mode tigre</span>
        <span class="chat-status" [class.connected]="isSignalRConnected">
          <span class="chat-status__dot"></span>
          {{ isSignalRConnected ? 'En ligne' : 'Hors ligne' }}
        </span>
      </div>
    </header>
    <div class="chat-window" *ngIf="selectedChat; else chatState">
      <div class="chat-messages" #chatMessages>
        <div
          *ngFor="let message of selectedChat.messages"
          class="chat-message"
          [class.chat-message--own]="message.senderId === currentUser?.id">
          <span class="chat-author">{{ message.senderName }}</span>
          <p class="chat-text">{{ message.content }}</p>
          <div *ngIf="message.attachments?.length" class="chat-attachments">
            <a
              *ngFor="let attachment of message.attachments"
              [href]="attachment.fileUrl"
              target="_blank"
              rel="noopener"
              class="chat-attachment">
              {{ attachment.fileName }}
            </a>
          </div>
          <span class="chat-time">{{ message.createdAt | date:'shortTime' }}</span>
        </div>
      </div>
      <div *ngIf="typingUsers.size > 0" class="chat-typing">
        {{ Array.from(typingUsers).join(', ') }} ecrit...
      </div>
    </div>
    <ng-template #chatState>
      <div class="chat-window chat-window--empty">
        <p *ngIf="isChatLoading">Chargement du chat...</p>
        <p *ngIf="!isChatLoading && chatError">{{ chatError }}</p>
        <p *ngIf="!isChatLoading && !chatError">Aucun chat disponible pour cette session.</p>
      </div>
    </ng-template>
    <div class="chat-input">
      <input
        type="text"
        placeholder="Ecrivez un message..."
        aria-label="Nouveau message"
        [(ngModel)]="messageContent"
        (keydown.enter)="sendMessage()"
        (input)="onMessageInput()"
        [disabled]="!selectedChat || isChatLoading"
      />
      <app-button
        variant="primary"
        (click)="sendMessage()"
        [disabled]="!selectedChat || !messageContent.trim() || isSendingMessage">
        {{ isSendingMessage ? 'Envoi...' : 'Envoyer' }}
      </app-button>
    </div>
  </aside>
</main>

<div *ngIf="showRatingModal" class="rating-modal" (click)="closeRatingModal()">
  <div class="rating-modal__card" (click)="$event.stopPropagation()">
    <h3 class="rating-modal__title">{{ isEditingRating ? 'Modifiez votre note' : 'Notez votre professeur' }}</h3>
    <p class="rating-modal__subtitle">Votre avis aide a ameliorer les cours.</p>
    <p *ngIf="isEditingRating" class="rating-info">Vous avez deja note ce professeur. Vous pouvez modifier votre avis.</p>
    <p *ngIf="isLoadingRating" class="rating-loading">Chargement de votre note...</p>
    <div class="rating-stars">
      <button
        type="button"
        class="rating-star"
        *ngFor="let star of [1, 2, 3, 4, 5]"
        [class.active]="ratingScore && star <= ratingScore"
        [disabled]="isLoadingRating"
        (click)="setRating(star)">
        ★
      </button>
    </div>
    <textarea
      class="rating-comment"
      rows="3"
      [(ngModel)]="ratingComment"
      [disabled]="isLoadingRating"
      placeholder="Ecrivez un commentaire (optionnel)">
    </textarea>
    <p *ngIf="ratingError" class="rating-error">{{ ratingError }}</p>
    <div class="rating-actions">
      <app-button variant="ghost" (click)="closeRatingModal()">Passer</app-button>
      <app-button
        variant="primary"
        (click)="submitRating()"
        [disabled]="isSubmittingRating || isLoadingRating">
        {{ isSubmittingRating ? 'Envoi...' : (isEditingRating ? 'Mettre a jour' : 'Envoyer') }}
      </app-button>
    </div>
  </div>
</div>
