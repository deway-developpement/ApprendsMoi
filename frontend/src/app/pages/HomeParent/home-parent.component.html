<app-header theme="light"></app-header>

<div class="dashboard-wrapper">
  
  <div class="dashboard-header-bg">
    <div class="header-content">
      <h1 class="welcome-title">Bonjour {{ userName }} ðŸ‘‹</h1>
      <p class="welcome-subtitle">Voici ce qu'il se passe pour vos enfants aujourd'hui.</p>
    </div>
  </div>

  <main class="dashboard-container">
    
    <section class="widgets-section">
      <div class="widgets-grid">
        
        <div class="widget-card accent-blue">
          <div class="widget-top">
            <div class="icon-circle blue">
              <app-small-icon icon="/assets/icons/schedule.svg" [size]="30"></app-small-icon>
            </div>
            <h3>Prochain cours</h3>
          </div>
          <div class="widget-content" *ngIf="nextCourse; else noCourse">
            <div class="main-info">
              <span class="big-date">{{ nextCourse.date | date:'dd MMM' }}</span>
              <span class="time">{{ nextCourse.date | date:'HH:mm' }}</span>
            </div>
            <p class="subtext">Avec {{ nextCourse.tutorName }} ({{ nextCourse.subject }})</p>
            <div class="widget-action">
              <app-button variant="ghost" [routerLink]="['/courses', nextCourse.id]">Voir les dÃ©tails</app-button>
            </div>
          </div>
          <ng-template #noCourse>
            <div class="widget-content">
               <p class="empty-state">Aucun cours planifiÃ©.</p>
               <div class="widget-action">
                  <app-button variant="ghost" [routerLink]="['/search']">Trouver un prof</app-button>
               </div>
            </div>
          </ng-template>
        </div>

        <div class="widget-card accent-orange">
          <div class="widget-top">
             <div class="icon-circle orange">
               <app-small-icon icon="/assets/icons/email 2 1.svg" [size]="30"></app-small-icon>
             </div>
            <h3>Messages</h3>
          </div>
          <div class="widget-content" *ngIf="lastMessage; else noMessage">
            <p class="message-preview">"{{ lastMessage.preview | slice:0:35 }}..."</p>
            <p class="subtext">De: <strong>{{ lastMessage.sender }}</strong></p>
            <div class="widget-action">
              <app-button variant="ghost" [routerLink]="['/messages']">Ouvrir la messagerie</app-button>
            </div>
          </div>
          <ng-template #noMessage>
             <div class="widget-content">
                <p class="empty-state">Aucun nouveau message.</p>
             </div>
          </ng-template>
        </div>

        <div class="widget-card accent-green">
          <div class="widget-top">
            <div class="icon-circle green">
              <app-small-icon icon="/assets/icons/account-balance.svg" [size]="30"></app-small-icon>
            </div>
            <h3>Paiements</h3>
          </div>
          <div class="widget-content" *ngIf="lastPayment">
            <p class="highlight-price">-{{ lastPayment.amount }} â‚¬</p>
            <p class="status-pill paid">{{ lastPayment.status }}</p>
            <div class="widget-action">
              <app-button variant="ghost" [routerLink]="['/payments']">Factures et paiements</app-button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="quick-actions">
      <button class="action-tile cta-search" [routerLink]="['/search']">
        <div class="tile-icon">
          <app-icon icon="/assets/icons/search.svg" [size]="48"></app-icon>
        </div>
        <div class="tile-text">
          <span class="tile-title">Trouver un prof</span>
          <span class="tile-desc">Maths, Anglais, S.V.T...</span>
        </div>
      </button>

      <button class="action-tile secondary" [routerLink]="['/favorites']">
        <div class="tile-icon">
          <app-icon icon="/assets/icons/star.svg" [size]="40"></app-icon>
        </div>
        <span>Mes Favoris</span>
      </button>

      <button class="action-tile secondary" [routerLink]="['/courses']">
        <div class="tile-icon">
          <app-icon icon="/assets/icons/book-fill.svg" [size]="40"></app-icon>
        </div>
        <span>GÃ©rer mes cours</span>
      </button>
      
    </section>

    <div class="content-split">
      <section class="children-section">
        <div class="section-header">
          <h2>ðŸ‘¦ Mes enfants</h2>
        </div>

        <div class="children-list">
          <div class="child-card" *ngFor="let child of children" [style.border-left-color]="child.avatarColor" (click)="openDetailsModal(child)">
            <div class="child-avatar" [style.background-color]="child.avatarColor">
              {{ child.firstName.charAt(0) }}
            </div>
            <div class="child-info">
              <h3>{{ child.firstName }}</h3>
              <p class="child-level">{{ child.levelLabel }}</p>
            </div>
            <div class="child-actions">
               <app-icon-button 
                icon="/assets/icons/tabler_trash.svg" 
                [size]="24" 
                (click)="deleteChild(child.id)">
              </app-icon-button>
            </div>
          </div>
          
          <div class="child-card add-new" (click)="openChildModal()">
             <div class="add-icon">+</div>
             <span>Nouveau profil</span>
           </div>
        </div>
      </section>

      <app-courses-schedule [courses]="courses"></app-courses-schedule>
    </div>

    <section class="promo-banner">
      <div class="promo-content">
        <h3>ðŸš€ Boostez la rÃ©ussite de vos enfants !</h3>
        <p>DÃ©couvrez nos professeurs Premium pour un accompagnement d'excellence.</p>
      </div>
      <app-button variant="primary" [routerLink]="['/search']" [queryParams]="{ premium: true }">
        Voir les profs Premium
      </app-button>
    </section>

  </main>
</div>

<div class="modal-overlay" *ngIf="showChildModal" (click)="closeChildModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h2>Ajouter un enfant</h2>
    <p class="modal-intro">Cela crÃ©era un compte Ã©tudiant pour votre enfant.</p>
    
    <div class="form-group">
      <app-text-input 
        label="PrÃ©nom" 
        placeholder="Ex: Lucas" 
        [value]="newChildName"
        (valueChange)="newChildName = $event">
      </app-text-input>
    </div>

    <div class="form-group">
      <app-text-input 
        label="Date de naissance" 
        type="date"
        [value]="newChildBirthDate"
        (valueChange)="newChildBirthDate = $event">
      </app-text-input>
    </div>

    <div class="form-group">
      <app-select 
        label="Niveau Scolaire" 
        [options]="levelOptions"
        (valueChange)="newChildLevel = $event">
      </app-select>
    </div>

    <div class="form-group">
      <app-text-input 
        label="Mot de passe du compte enfant" 
        type="password"
        placeholder="6 caractÃ¨res minimum" 
        [value]="newChildPassword"
        (valueChange)="newChildPassword = $event">
      </app-text-input>
    </div>

    <div class="modal-actions">
      <app-button variant="ghost" (click)="closeChildModal()" [disabled]="isLoading">
        Annuler
      </app-button>
      
      <app-button variant="primary" (click)="saveChild()" [disabled]="isLoading">
        {{ isLoading ? 'CrÃ©ation...' : 'CrÃ©er le compte' }}
      </app-button>
    </div>
  </div>
</div>



<div class="modal-overlay" *ngIf="showDetailsModal && selectedChild" (click)="closeDetailsModal()">
  <div class="modal-content details-modal" (click)="$event.stopPropagation()">
    
    <header class="details-header">
      <div class="child-avatar large" [style.background-color]="selectedChild.avatarColor">
        {{ selectedChild.firstName.charAt(0) }}
      </div>
      <h2>{{ selectedChild.firstName }} {{ selectedChild.lastName }}</h2>
      <p class="subtitle">Profil Ã‰lÃ¨ve</p>
    </header>

    <div class="details-body">
      <div class="info-row">
        <span class="label">Niveau scolaire</span>
        <span class="value">{{ selectedChild.levelLabel }}</span>
      </div>
      
      <div class="info-row">
        <span class="label">Nom d'utilisateur</span>
        <span class="value highlight">{{ selectedChild.username }}</span>
      </div>
      
      <div class="info-row" *ngIf="selectedChild.firstName">
        <span class="label">Statut</span>
        <span class="value badge-success">Actif</span>
      </div>
    </div>

    <div class="modal-actions centered">
      <app-button variant="primary" (click)="closeDetailsModal()">Fermer</app-button>
    </div>
  </div>
</div>