<app-header theme="light"></app-header>

<div class="dashboard-wrapper">
  <div class="dashboard-header-bg">
    <div class="header-content">
      <h1 class="welcome-title">Bonjour {{ userName }}</h1>
      <p class="welcome-subtitle">Voici ce qu'il se passe pour vos enfants aujourd'hui.</p>
    </div>
  </div>

  <main class="dashboard-container">
    <section class="widgets-section">
      <div class="widgets-grid">
        <div class="widget-card accent-blue">
          <div class="widget-top">
            <div class="icon-circle blue">
              <app-small-icon icon="/assets/icons/account-balance.svg" [size]="30"></app-small-icon>
            </div>
            <h3>Dette totale</h3>
          </div>
          <div class="widget-content">
            <p class="metric-value">{{ totalDebtFormatted }}</p>
            <p class="subtext">Factures en attente de paiement</p>
            <div class="widget-action">
              <app-button variant="ghost" [routerLink]="['/payments']">Voir les paiements</app-button>
            </div>
          </div>
        </div>

        <div class="widget-card accent-orange">
          <div class="widget-top">
            <div class="icon-circle orange">
              <app-small-icon icon="/assets/icons/book-fill.svg" [size]="30"></app-small-icon>
            </div>
            <h3>Cours réservés ce mois</h3>
          </div>
          <div class="widget-content">
            <p class="metric-value">{{ coursesBookedThisMonthFormatted }}</p>
            <p class="subtext">Nombre total de réservations ce mois</p>
          </div>
        </div>

        <div class="widget-card accent-green">
          <div class="widget-top">
            <div class="icon-circle green">
              <app-small-icon icon="/assets/icons/people.svg" [size]="30"></app-small-icon>
            </div>
            <h3>Nombre d'enfants</h3>
          </div>
          <div class="widget-content">
            <p class="metric-value">{{ numberOfChildrenFormatted }}</p>
            <p class="subtext">Profils élèves rattachés à votre compte</p>
          </div>
        </div>
      </div>
    </section>

    <section class="quick-actions">
      <button class="action-tile cta-search" [routerLink]="['/search']">
        <div class="tile-icon">
          <app-icon icon="/assets/icons/search.svg" [size]="48"></app-icon>
        </div>
        <div class="tile-text">
          <span class="tile-title">Trouver un prof</span>
          <span class="tile-desc">Maths, Anglais, S.V.T...</span>
        </div>
      </button>

      <button class="action-tile secondary" [routerLink]="['/favorites']">
        <div class="tile-icon">
          <app-icon icon="/assets/icons/star.svg" [size]="40"></app-icon>
        </div>
        <span>Mes Favoris</span>
      </button>

      <button class="action-tile secondary" [routerLink]="['/courses']">
        <div class="tile-icon">
          <app-icon icon="/assets/icons/book-fill.svg" [size]="40"></app-icon>
        </div>
        <span>Gérer mes cours</span>
      </button>
    </section>

    <div class="content-split">
      <section class="children-section">
        <div class="section-header">
          <h2>Mes enfants</h2>
        </div>

        <div class="children-list">
          <div class="child-card" *ngFor="let child of children" [style.border-left-color]="child.avatarColor" (click)="openDetailsModal(child)">
            <div class="child-avatar" [style.background-color]="child.avatarColor">
              {{ child.firstName.charAt(0) }}
            </div>
            <div class="child-info">
              <h3>{{ child.firstName }}</h3>
              <p class="child-level">{{ child.levelLabel }}</p>
            </div>
            <div class="child-actions">
              <app-icon-button
                icon="/assets/icons/tabler_trash.svg"
                [size]="24"
                (click)="deleteChild(child.id)">
              </app-icon-button>
            </div>
          </div>

          <div class="child-card add-new" (click)="openChildModal()">
            <div class="add-icon">+</div>
            <span>Nouveau profil</span>
          </div>
        </div>
      </section>

      <app-courses-schedule [courses]="courses" (action)="openVisio($event)"></app-courses-schedule>
    </div>

    <section class="promo-banner">
      <div class="promo-content">
        <h3>Boostez la reussite de vos enfants !</h3>
        <p>Decouvrez nos professeurs Premium pour un accompagnement d'excellence.</p>
      </div>
      <app-button variant="primary" [routerLink]="['/search']" [queryParams]="{ premium: true }">
        Voir les profs Premium
      </app-button>
    </section>
  </main>
</div>

<div class="modal-overlay" *ngIf="showChildModal" (click)="closeChildModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h2>Ajouter un enfant</h2>
    <p class="modal-intro">Cela creera un compte etudiant pour votre enfant.</p>

    <div class="form-group">
      <app-text-input
        label="Prenom"
        placeholder="Ex: Lucas"
        [value]="newChildName"
        (valueChange)="newChildName = $event">
      </app-text-input>
    </div>

    <div class="form-group">
      <app-text-input
        label="Date de naissance"
        type="date"
        [value]="newChildBirthDate"
        (valueChange)="newChildBirthDate = $event">
      </app-text-input>
    </div>

    <div class="form-group">
      <app-select
        label="Niveau Scolaire"
        [options]="levelOptions"
        (valueChange)="newChildLevel = $event">
      </app-select>
    </div>

    <div class="form-group">
      <app-text-input
        label="Mot de passe du compte enfant"
        type="password"
        placeholder="6 caracteres minimum"
        [value]="newChildPassword"
        (valueChange)="newChildPassword = $event">
      </app-text-input>
    </div>

    <div class="modal-actions">
      <app-button variant="ghost" (click)="closeChildModal()" [disabled]="isLoading">
        Annuler
      </app-button>

      <app-button variant="primary" (click)="saveChild()" [disabled]="isLoading">
        {{ isLoading ? 'Creation...' : 'Creer le compte' }}
      </app-button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showDetailsModal && selectedChild" (click)="closeDetailsModal()">
  <div class="modal-content details-modal" (click)="$event.stopPropagation()">
    <header class="details-header">
      <div class="child-avatar large" [style.background-color]="selectedChild.avatarColor">
        {{ selectedChild.firstName.charAt(0) }}
      </div>
      <h2>{{ selectedChild.firstName }} {{ selectedChild.lastName }}</h2>
      <p class="subtitle">Profil Élève</p>
    </header>

    <div class="details-body">
      <div class="info-row">
        <span class="label">Niveau scolaire</span>
        <span class="value">{{ selectedChild.levelLabel }}</span>
      </div>

      <div class="info-row">
        <span class="label">Nom d'utilisateur</span>
        <span class="value highlight">{{ selectedChild.username }}</span>
      </div>

      <div class="info-row" *ngIf="selectedChild.firstName">
        <span class="label">Statut</span>
        <span class="value badge-success">Actif</span>
      </div>
    </div>

    <div class="modal-actions centered">
      <app-button variant="primary" (click)="closeDetailsModal()">Fermer</app-button>
    </div>
  </div>
</div>
